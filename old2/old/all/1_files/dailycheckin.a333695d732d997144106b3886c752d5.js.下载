$.ajaxSetup({cache:false});function start_spin(id){var opts={lines:13,width:3,length:5,radius:5,zIndex:2e9,color:'#209E85',top:'auto',left:'auto'};var target=document.getElementById(id);$(target).empty();var spinner=new Spinner(opts).spin(target);$(target).show();}
var isTestEnvironment=(function(){return window.location&&window.location.hostname.indexOf('daydayup')!==-1||false;}());var PromotionView=Backbone.View.extend({initialize:function(){_.bindAll(this,'render');this.$el=$('#associate-promotion');this.fetchData();},fetchData:function(){var self=this;$.ajax({url:isTestEnvironment?'https://www.daydayup.me/api/v2/soup/web_checkin/campaigns/today/':'https://rest.shanbay.com/api/v2/soup/web_checkin/campaigns/today/',type:'GET',xhrFields:{withCredentials:true},crossDomain:true,success:function(res){var renderNoPromotion=function(){var $promotion=$('#associate-promotion').closest('.checkin-container-outer');$promotion.addClass('no-promotion');$('#checkin-container-inner .span8').removeClass('span8').addClass('span12');$promotion.find('.checkin-form .span8').removeClass('span8').addClass('span12');$promotion.find('.checkin-form form').removeClass('span6').addClass('span10');$promotion.find('.note .span6').removeClass('span6').addClass('span10');}
if(!res.data||!res.data.id){renderNoPromotion();return;}
var data=res.data;self.render(data);}});},render:function(data){var html=$('#associate-promotion-tmpl').tmpl({'promotion':data})
this.$el.html(html);}});var Notification=Backbone.Model.extend({urlRoot:'/api/v1/notification/'});function getCookie(c_name){if(document.cookie.length>0){c_start=document.cookie.indexOf(c_name+"=");if(c_start!=-1){c_start=c_start+c_name.length+1;c_end=document.cookie.indexOf(";",c_start);if(c_end==-1)
c_end=document.cookie.length;return unescape(document.cookie.substring(c_start,c_end));}}
return"";}
var NotificationView=Backbone.View.extend({el:'body',url:'https://www.shanbay.com/api/v2/notification/',events:{"click .only_one_notification":'clear_notification',"click .notification_redirect":'notification_redirect'},notification_redirect:function(e){var url=$(e.currentTarget).attr('data');var id=$(e.currentTarget).attr('noti-id');var ajax_url=this.url+'usernotifications/'+id+'/clear/';$.ajax({url:ajax_url,type:'post',headers:{"X-CSRFToken":getCookie("csrftoken")},xhrFields:{withCredentials:true},success:function(data){location.href=url;}});},clear_notification:function(e){var url=$(e.currentTarget).attr('href');$.ajax({url:url,type:"get",success:function(data){}})
e.preventDefault();$(e.currentTarget).parent().hide();if($('.noty_text li').length==1){$('#notification-container').remove();}
return false;},initialize:function(){this.model=new Notification();this.model.bind("change",this.render,this);var _this=this;$.ajax({url:this.url+'usernotifications/',headers:{"X-CSRFToken":getCookie("csrftoken")},xhrFields:{withCredentials:true},success:function(res){_this.model.set('data',res.data);}});},render_notification_box:function(html){if(html.length){$('#notification-container').noty({"text":html,"timeout":50000000,"closeButton":true,"modal":false,"closeOnSelfClick":false});}},render:function(){var self=this;var data=this.model.get('data');var html="";var exclude_notifications=['checkin.voice_remind','speak.course_completed','speak.unit_completed','team.notification.team_badge'];if(data&&data.length){_.each(data,function(v){if(_.contains(exclude_notifications,v.notification.event)){return;}
var content=v.content;var link=' <a noti-id="'+v.id+'" class="notification_redirect" href="javascript:; "data="'+v.notification.redirect_url+'">查看详情</a></li>';var li='<li>'+content+link+'</li>';html+=li;});self.render_notification_box(html);}}});var Checkin=Backbone.Model.extend({urlRoot:'/api/v1/checkin/?for_web=true',parse:function(response){return response.data;}})
var TaskView=Backbone.View.extend({el:'#checkin-box',events:{'click .share':'share','click .share-promotion':'share_promotion','click #checkin_button':'checkin_user','click .tasks-container .task':'jump_to_task','click #captcha-image':'update_captcha'},initialize:function(){_.bindAll(this,'render','show_edit_note','cancel_edit_note','edit_note')
this.model.fetch();this.model.on('change',this.render);},share:function(e){var $target=$(e.currentTarget);if($target.hasClass('disabled')){return;}
$target.addClass('disabled');var service=$target.attr('service');var checkin_id=this.model.get('id');start_spin('sharing-spinner');$('#sharing').show();$.get(['/api/v1/checkin/share',service,checkin_id,''].join('/'),function(res){$('#sharing').hide();if(res.status_code==0){$('#share-result').addClass('alert alert-success').text('分享成功').show().fadeOut(2000);return;}else if(res.status_code==401||res.status_code==400){window.location.href="/social/login/"+service+'?next=/';}else if(res.status_code==404){widow.location.href="/404"}else{$('#share-result').addClass('alert alert-danger').text('网络错误，请稍后重试').show().fadeOut(3000);}
$target.removeClass('disabled');});},share_promotion:function(e){var $target=$(e.currentTarget);if($target.hasClass('disabled')){return;}
$target.addClass('disabled');var service=$target.attr('service');var promotion_id=$target.attr('promotion_id');start_spin('promotion-sharing-spinner');$('#promotion-sharing').show();$.get(['/api/v1/associate/share',service,promotion_id,''].join('/'),function(res){$('#promotion-sharing').hide();if(res.status_code==0){$('#promotion-share-result').addClass('alert alert-success').text('分享成功').show().fadeOut(2000);return;}else if(res.status_code==401||res.status_code==400){window.location.href="/social/login/"+service+'?next=/';}else if(res.status_code==404){window.location.href="/404"}else{$('#promotion-share-result').addClass('alert alert-danger').text('网络错误，请稍后重试').show().fadeOut(3000);}
$target.removeClass('disabled');});},checkin_user:function(e){e.preventDefault();if($(e.currentTarget).hasClass('disabled')){return;}
var user_note=$('textarea.user-note').val();var captcha_key=this.$('#captcha-container input[name=captcha_key]').val();var captcha_code=this.$('#captcha-container input[name=captcha_code]').val();if(!this.$('#captcha-container').hasClass('hide')&&captcha_code.length!=4){alert(this.$('#captcha-container input[name=captcha_code]').attr('placeholder'));return;}
var original_text=$(e.currentTarget).text();$(e.currentTarget).addClass('disabled').text(TEXTS['submitting']);var model=this.model;var data={'user_note':user_note,'captcha_key':captcha_key,'captcha_code':captcha_code};this.model.save(data,{success:function(model,response){if(response.status_code==0){model.set('checked',true);}
else{alert(response.msg);$(e.currentTarget).removeClass('disabled').text(original_text);model.set('status',response.status);}},wait:true});},update_captcha:function(e){that=this;$.ajax({url:'/api/v1/account/captcha/',type:"get",success:function(res){that.$('#captcha-container input[name=captcha_key]').val(res.data.key);that.$('#captcha-container img').attr('src',res.data.image_url);}})},render:function(){var checkin=this.model.toJSON();if(checkin.num_checkin_days>3){$('.punch-intro-container a').hide();}
if(checkin.checked||checkin.finished){var total_time=0;_.each(checkin.tasks,function(element,key){if(element.meta&&element.meta.used_time){total_time+=element.meta.used_time;}
_.each(element.meta,function(value,key){$('.'+key,'.checkin_days_content').find('.number').text(value);});});this.$('.total_time').text(total_time);this.$('.finished').show();this.$('.daily-quote-container').hide();this.$('.checkin-container').show();var promotion_view=new PromotionView();}
if(checkin.checked){this.$('.checkin-form').hide();this.$('.note').show()
var note=checkin.user_note;if(!note)
note=$('.quote').html();this.$('.checkin-note').html(note);this.$('.checkin-share').show();this.$('.checkin-title #checkin-days').text(checkin.num_checkin_days);this.$('.checkin-title').show();}else if(checkin.finished){this.$('.checkin-form').show();if(checkin.need_captcha){this.update_captcha();this.$('#captcha-container').removeClass('hide');}
this.$('.checkin-title #checkin-days').text(checkin.num_checkin_days+1);this.$('.checkin-title').show();$('.user-note').focus();}
if(checkin.status&&checkin.status_code!=0){this.$('.error').show();this.$('#checkin-error').text(checkin.status.msg);}
var tasksSequence=['bdc','listen','speak','read','sentence'];var tasks=[];_.each(tasksSequence,function(taskName,index){var newTask=_.filter(checkin.tasks,function(task){return task.name===taskName;});tasks.push(newTask[0]);});var tasks=_.filter(tasks,function(task){return task.name!=='speak'||task.name==='speak'&&task.finished;});if(tasks.length===5){this.$('.tasks-container').addClass('with-speak');}else{this.$('.tasks-container').removeClass('with-speak');}
this.$('.tasks-container').html($('#tasks-tmpl').tmpl({"tasks":tasks}));return this;},jump_to_task:function(e){var $target=$(e.target);var url=$target.parents().find('.task').attr('data');location.href=url;},show_edit_note:function(e){var $target=$(e.target);$target.parent().find('textarea').val('');$target.parent().find('.edit-checkin-note-container').show();},cancel_edit_note:function(e){var $target=$(e.target);$target.parent().hide();},edit_note:function(e){var $target=$(e.target);$target.attr('disabled',true);var checkin_id=$target.attr('data');var user_note=$target.parent().find('textarea').val();this.model.save({'user_note':user_note,'checkin_id':this.model.id},{url:this.model.urlRoot,success:function(){$target.attr('disabled',false).parent().hide();},wait:true});}});var HomeRouter=Backbone.Router.extend({routes:{'':'init'},init:function(){start_task_loading_spin();var checkin=new Checkin();new TaskView({model:checkin});var notification_view=new NotificationView();}})
var promotes=[];promotes.push('/api/v1/team/promotion/');promotes.push('/api/v1/sentence/promotion/?type=new');promotes.push('/api/v1/read/promotion/?type=new');function fetch(){for(var i=0,len=promotes.length;i<len;i++){$.get(promotes[i],function(response){if(response.status_code==0){var object=response.data;$('#'+object.type).html($('#promotion-tmpl').tmpl(object));}
init_redirect();})};};function init_redirect(){$('.promotion-item-container').unbind('click').click(function(){var url=$(this).attr('data');location.href=url;});$('.promotion-item-container').unbind('hover').hover(function(){var img=$(this).find('img');if(img.length){var height=parseInt(img.css('height').replace('px',''));img.css('height',(height+2).toString()+'px');}},function(){var img=$(this).find('img');if(img.length){var height=parseInt(img.css('height').replace('px',''));img.css('height',(height-2).toString()+'px');}});$('.promotion-img').unbind('hover').hover(function(){var height=parseInt($(this).css('height').replace('px',''));$(this).css('height',(height+2).toString()+'px');},function(){var height=parseInt($(this).css('height').replace('px',''));$(this).css('height',(height-2).toString()+'px');});}
function start_task_loading_spin(){var opts={lines:13,zIndex:2e9,color:'#209E85',top:'auto',left:'auto'};var targets=$('.task-loading-spinner');_.each(targets,function(t,index){var spinner=new Spinner(opts).spin(t);$(t).parent().show();})}